# GitHub Actions workflow for building and pushing PHP 8.1 Apache Docker image
# Repository: github.com/mvandrew/bitrix-env
#
# This workflow builds the PHP 8.1 Apache image optimized for 1C-Bitrix
# and pushes it to Docker Hub as msav/bitrix-php-apache:8.1
#
# Note: This is a multi-stage build that compiles many PHP extensions,
# so it takes longer to build than simple images (up to 30-60 minutes)
#
# Required secrets:
#   - DOCKERHUB_USERNAME: Docker Hub username
#   - DOCKERHUB_TOKEN: Docker Hub access token

name: Build and Push PHP 8.1 Apache

on:
  # Manual trigger via GitHub UI or API
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests before push'
        required: false
        default: 'false'
        type: boolean

  # Automatic trigger on push to master branch
  push:
    branches:
      - master
    paths:
      - 'images/php-apache/8.1/**'
      - 'images/php-apache/base/**'

env:
  IMAGE_NAME: msav/bitrix-php-apache
  TAG: "8.1"
  TEST_CONTAINER_NAME: php-apache-8.1-test
  TEST_PORT: 8888

jobs:
  build-test-push:
    name: Build, Test and Push PHP 8.1 Apache
    runs-on: self-hosted
    timeout-minutes: 60  # Multi-stage build takes longer

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build Docker image
        working-directory: images/php-apache
        run: |
          echo "Building ${{ env.IMAGE_NAME }}:${{ env.TAG }}..."
          echo "Note: Multi-stage build may take 20-40 minutes"
          docker build --rm -t ${{ env.IMAGE_NAME }}:${{ env.TAG }} -f 8.1/Dockerfile .
          echo "Build completed successfully"

      - name: Test PHP image
        if: ${{ github.event.inputs.skip_tests != 'true' }}
        run: |
          echo "=== Testing PHP 8.1 Apache image ==="
          echo ""

          echo "1. Testing PHP version..."
          docker run --rm ${{ env.IMAGE_NAME }}:${{ env.TAG }} php -v | head -1

          echo ""
          echo "2. Testing key extensions..."
          docker run --rm ${{ env.IMAGE_NAME }}:${{ env.TAG }} php -m | grep -E '^(redis|imagick|opcache|mysqli|gd|memcached)$' | sort

          echo ""
          echo "3. Testing all required extensions..."
          docker run --rm ${{ env.IMAGE_NAME }}:${{ env.TAG }} php -m | grep -E '^(bz2|calendar|curl|exif|gd|gettext|imap|ldap|mbstring|mcrypt|memcache|memcached|mysqli|opcache|pdo_mysql|redis|sockets|zip|imagick|amqp|igbinary|msgpack|lz4|zstd|lzf|rdkafka|rrd|xlswriter)$' | wc -l

          echo ""
          echo "4. Testing health check endpoint..."
          docker run --rm -d -p ${{ env.TEST_PORT }}:80 --name ${{ env.TEST_CONTAINER_NAME }} ${{ env.IMAGE_NAME }}:${{ env.TAG }}
          sleep 5

          if curl -sf http://localhost:${{ env.TEST_PORT }}/health.php; then
            echo " - Health check OK"
          else
            echo " - Health check failed!"
            docker stop ${{ env.TEST_CONTAINER_NAME }} 2>/dev/null || true
            exit 1
          fi

          docker stop ${{ env.TEST_CONTAINER_NAME }} 2>/dev/null || true

          echo ""
          echo "5. Verifying PEAR DB package..."
          docker run --rm ${{ env.IMAGE_NAME }}:${{ env.TAG }} test -f /usr/local/lib/php/DB.php && echo "PEAR DB.php - OK"

          echo ""
          echo "=== All tests passed! ==="

      - name: Cleanup test container on failure
        if: failure()
        run: |
          docker stop ${{ env.TEST_CONTAINER_NAME }} 2>/dev/null || true
          docker rm ${{ env.TEST_CONTAINER_NAME }} 2>/dev/null || true

      - name: Push to Docker Hub
        run: |
          echo "Pushing ${{ env.IMAGE_NAME }}:${{ env.TAG }} to Docker Hub..."
          docker push ${{ env.IMAGE_NAME }}:${{ env.TAG }}
          echo "Push completed successfully"

      - name: Image info
        run: |
          echo ""
          echo "=== Image Published ==="
          echo "Image: ${{ env.IMAGE_NAME }}:${{ env.TAG }}"
          echo "Pull command: docker pull ${{ env.IMAGE_NAME }}:${{ env.TAG }}"
          echo ""
          echo "Included PHP extensions:"
          echo "  Core: mysqli, pdo_mysql, gd, mbstring, curl, xml, zip, opcache"
          echo "  Cache: redis, memcached, memcache"
          echo "  Compression: lz4, zstd, lzf, bz2"
          echo "  Messaging: amqp, rdkafka"
          echo "  Other: imagick, imap, ldap, mcrypt, xlswriter, rrd"
          echo ""
